<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Xoay Ảnh (4GB Edition)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #1e1e1e; color: #fff; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: #2d2d2d; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        
        /* Khu vực chọn file to đẹp */
        .upload-area { 
            border: 3px dashed #555; padding: 40px; margin-bottom: 20px; border-radius: 12px; 
            cursor: pointer; transition: all 0.3s; background: #252525;
        }
        .upload-area:hover { border-color: #007bff; background: #333; transform: scale(1.01); }
        .upload-icon { font-size: 50px; color: #007bff; margin-bottom: 10px; }
        
        .image-wrapper { 
            position: relative; height: 600px; background-color: #000; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 8px; overflow: hidden; margin: 20px 0; border: 2px solid #444; 
        }
        #currentImage { max-height: 100%; max-width: 100%; transition: transform 0.2s; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 15px; }
        button { 
            padding: 12px 25px; cursor: pointer; border: none; border-radius: 8px; 
            font-weight: bold; color: white; display: flex; align-items: center; gap: 10px; font-size: 16px; 
            transition: 0.2s;
        }
        button:disabled { background: #444 !important; color: #888; cursor: not-allowed; transform: none !important; }
        button:hover { filter: brightness(1.1); transform: translateY(-2px); }
        
        .btn-rotate { background: #17a2b8; }
        .btn-nav { background: #28a745; width: 180px; justify-content: center; } 
        .btn-dl { background: #ffc107; color: #333; width: 100%; justify-content: center; margin-top: 20px; font-size: 20px; padding: 15px; }
        
        .status-bar { display: flex; justify-content: space-between; color: #ccc; margin-bottom: 10px; font-size: 14px; }
        .filename { font-size: 20px; color: #ffc107; font-weight: bold; }
        .badge-edited { background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; vertical-align: middle; display: none; }

        /* Màn hình loading xịn */
        #loadingOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
        }
        .progress-bar { width: 300px; height: 10px; background: #444; border-radius: 5px; margin-top: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: #28a745; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <h2 style="color: #17a2b8;">Đang xử lý...</h2>
    <p id="progressText" style="font-size: 18px; margin-top: 10px;">0%</p>
    <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
    <p style="color: #888; margin-top: 15px; font-size: 14px;">Đừng tắt trình duyệt nhé!</p>
</div>

<div class="container">
    <h2><i class="fas fa-layer-group"></i> Tool Xoay Ảnh (Xử lý hàng loạt)</h2>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-cloud-upload-alt upload-icon"></i>
        <h3>Bấm vào đây để chọn ảnh từ máy tính</h3>
        <p style="color: #aaa;">(Mẹo: Với 4GB ảnh, hãy chia nhỏ và làm mỗi lần khoảng 100-200 cái)</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFiles(this.files)">
    </div>

    <div class="status-bar">
        <span>[←/→]: Xoay | [A/D]: Next</span>
        <span id="counter">0 / 0</span>
    </div>

    <div>
        <span class="filename" id="fileNameDisplay">...</span>
        <span id="editedBadge" class="badge-edited">ĐÃ XOAY</span>
    </div>
    
    <div class="image-wrapper">
        <img id="currentImage" src="" alt="">
    </div>

    <div class="controls">
        <button class="btn-nav" id="btnPrev" onclick="navigate(-1)" disabled><i class="fas fa-arrow-left"></i> (A) Quay lại</button>
        <button class="btn-rotate" onclick="rotate(-90)"><i class="fas fa-undo"></i> Trái</button>
        <button class="btn-rotate" onclick="rotate(90)">Phải <i class="fas fa-redo"></i></button>
        <button class="btn-nav" id="btnNext" onclick="navigate(1)" disabled>(D) Tiếp theo <i class="fas fa-arrow-right"></i></button>
    </div>

    <button onclick="processAndDownload()" class="btn-dl" id="btnDownload" disabled>
        <i class="fas fa-file-archive"></i> Tải Zip kết quả
    </button>
</div>

<script>
    let fileList = []; 
    let angles = [];   
    let currentIndex = 0;
    
    // Cờ kiểm tra xem người dùng có lỡ tay tắt tab không
    window.onbeforeunload = function() {
        if (fileList.length > 0) return "Dữ liệu chưa lưu sẽ bị mất!";
    };

    function handleFiles(files) {
        if (files.length === 0) return;
        
        // Cảnh báo nếu chọn quá nhiều
        if (files.length > 300) {
            if(!confirm(`Bạn đã chọn ${files.length} ảnh. Số lượng lớn có thể làm trình duyệt bị chậm.\nBạn có muốn tiếp tục không?`)) return;
        }

        fileList = Array.from(files).sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
        angles = new Array(fileList.length).fill(0);
        currentIndex = 0;
        
        updateUI();
        loadImage();
        
        document.getElementById('btnNext').disabled = false;
        document.getElementById('btnPrev').disabled = false;
        document.getElementById('btnDownload').disabled = false;
    }

    function loadImage() {
        if (fileList.length === 0) return;
        const file = fileList[currentIndex];
        const angle = angles[currentIndex];

        document.getElementById('fileNameDisplay').innerText = file.name;
        document.getElementById('counter').innerText = `${currentIndex + 1} / ${fileList.length}`;
        
        // Badge
        const badge = document.getElementById('editedBadge');
        badge.style.display = (angle % 360 !== 0) ? "inline-block" : "none";

        // Dọn dẹp bộ nhớ ảnh cũ để tránh tràn RAM
        const img = document.getElementById('currentImage');
        if (img.src) URL.revokeObjectURL(img.src);

        img.src = URL.createObjectURL(file);
        img.style.transform = `rotate(${angle}deg)`;
    }

    function rotate(deg) {
        if (fileList.length === 0) return;
        angles[currentIndex] += deg;
        
        // Xoay visual
        document.getElementById('currentImage').style.transform = `rotate(${angles[currentIndex]}deg)`;
        
        // Update badge
        const badge = document.getElementById('editedBadge');
        badge.style.display = (angles[currentIndex] % 360 !== 0) ? "inline-block" : "none";
    }

    function navigate(direction) {
        if (fileList.length === 0) return;
        const nextIndex = currentIndex + direction;
        
        if (nextIndex >= 0 && nextIndex < fileList.length) {
            currentIndex = nextIndex;
            loadImage();
        } else if (nextIndex >= fileList.length) {
            // Khi hết danh sách
            if(confirm("Đã hết danh sách ảnh! Bạn có muốn tải Zip về ngay không?")) {
                processAndDownload();
            }
        }
    }

    async function processAndDownload() {
        if (fileList.length === 0) return;
        if (!confirm("Bắt đầu xử lý và nén file? Máy có thể hơi lag một chút nhé.")) return;

        const zip = new JSZip();
        const overlay = document.getElementById('loadingOverlay');
        const progressText = document.getElementById('progressText');
        const progressFill = document.getElementById('progressFill');
        
        overlay.style.display = 'flex';

        for (let i = 0; i < fileList.length; i++) {
            const percent = Math.round(((i + 1) / fileList.length) * 100);
            progressText.innerText = `Đang xử lý ảnh ${i + 1}/${fileList.length} (${percent}%)`;
            progressFill.style.width = `${percent}%`;

            const file = fileList[i];
            const angle = angles[i] % 360;

            try {
                if (angle === 0) {
                    zip.file(file.name, file);
                } else {
                    const blob = await rotateImageFile(file, angle);
                    zip.file(file.name, blob);
                }
            } catch (err) {
                console.error("Lỗi file:", file.name, err);
            }
            
            // Cho trình duyệt thở 1 chút để cập nhật UI
            await new Promise(r => setTimeout(r, 0));
        }

        progressText.innerText = "Đang nén thành file Zip...";
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "anh_da_xoay.zip");
            overlay.style.display = 'none';
            alert("Xong! Đã tải xuống.");
            
            // Xóa danh sách để giải phóng RAM
            // location.reload(); 
        });
    }

    function rotateImageFile(file, angle) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                
                // Giữ nguyên độ phân giải gốc
                const rads = angle * Math.PI / 180;
                const newWidth = Math.abs(img.width * Math.cos(rads)) + Math.abs(img.height * Math.sin(rads));
                const newHeight = Math.abs(img.width * Math.sin(rads)) + Math.abs(img.height * Math.cos(rads));

                canvas.width = newWidth;
                canvas.height = newHeight;
                ctx.translate(newWidth / 2, newHeight / 2);
                ctx.rotate(rads);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);

                canvas.toBlob((blob) => {
                    resolve(blob);
                    // Dọn dẹp
                    URL.revokeObjectURL(img.src);
                }, file.type, 0.95); // Chất lượng 95%
            };
            img.src = URL.createObjectURL(file);
        });
    }

    // Phím tắt
    document.addEventListener('keydown', (e) => {
        if (fileList.length === 0) return;
        if (e.key === "ArrowLeft") rotate(-90);
        if (e.key === "ArrowRight") rotate(90);
        if (e.key === "a" || e.key === "A") navigate(-1);
        if (e.key === "d" || e.key === "D") navigate(1);
        if (e.key === "Enter") navigate(1);
    });
    
    function updateUI() {} 
</script>

</body>
</html>
