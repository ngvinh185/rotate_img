<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Xoay Ảnh (Auto Load)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #222; color: #fff; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #333; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        .image-wrapper { position: relative; height: 500px; background-color: #111; display: flex; align-items: center; justify-content: center; border-radius: 8px; overflow: hidden; margin: 20px 0; border: 2px solid #555; }
        #currentImage { max-height: 100%; max-width: 100%; transition: transform 0.3s; }
        
        .controls { display: flex; justify-content: center; gap: 12px; margin-top: 15px; }
        button { padding: 12px 24px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        button:disabled { background: #555 !important; cursor: not-allowed; opacity: 0.6; }
        .btn-rotate { background: #17a2b8; }
        .btn-nav { background: #28a745; width: 160px; justify-content: center; } 
        .btn-dl { background: #ffc107; color: #333; width: 100%; justify-content: center; margin-top: 20px; font-size: 18px; padding: 15px; }
        .status-bar { display: flex; justify-content: space-between; color: #aaa; margin-bottom: 10px; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .edited-badge { color: #28a745; font-weight: bold; margin-left: 10px; display: none;}
        
        /* Loading Spinner */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #17a2b8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner"></div>
    <h2 style="color: #17a2b8;" id="loadingTitle">Đang tải danh sách ảnh...</h2>
    <p id="progressText">Vui lòng đợi chút xíu...</p>
</div>

<div class="container">
    <h2><i class="fas fa-server"></i> Tool Xoay Ảnh (Dữ liệu trên Server)</h2>
    
    <div class="status-bar">
        <span>[←/→]: Xoay | [A/D]: Next</span>
        <span id="counter">0 / 0</span>
    </div>

    <div style="font-size: 18px; margin-bottom: 5px;">
        <span style="color: #ffc107; font-weight: bold;" id="fileNameDisplay">...</span>
        <span id="editedBadge" class="edited-badge"><i class="fas fa-check"></i> ĐÃ SỬA</span>
    </div>
    
    <div class="image-wrapper">
        <img id="currentImage" src="" alt="" crossorigin="anonymous">
    </div>

    <div class="controls">
        <button class="btn-nav" id="btnPrev" onclick="navigate(-1)" disabled><i class="fas fa-arrow-left"></i> (A) Quay lại</button>
        <button class="btn-rotate" onclick="rotate(-90)"><i class="fas fa-undo"></i> Trái</button>
        <button class="btn-rotate" onclick="rotate(90)">Phải <i class="fas fa-redo"></i></button>
        <button class="btn-nav" id="btnNext" onclick="navigate(1)" disabled>(D) Tiếp theo <i class="fas fa-arrow-right"></i></button>
    </div>

    <button onclick="processAndDownload()" class="btn-dl" id="btnDownload" disabled>
        <i class="fas fa-file-download"></i> Xong tất cả - Tải Zip về
    </button>
</div>

<script>
    // --- CẤU HÌNH TỰ ĐỘNG ---
    const GITHUB_USER = 'ngvinh185';
    const GITHUB_REPO = 'rotate_img';
    const IMAGE_FOLDER = 'images'; 
    // ------------------------

    let fileList = []; 
    let angles = [];   
    let currentIndex = 0;
    let hasUnsavedChanges = false;

    // Tự động chạy khi mở web
    window.onload = function() {
        fetchImageList();
    };

    window.onbeforeunload = function() {
        if (hasUnsavedChanges) return "Dữ liệu chưa lưu sẽ bị mất!";
    };

    // 1. Lấy danh sách ảnh từ GitHub API
    async function fetchImageList() {
        const apiUrl = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/${IMAGE_FOLDER}`;
        
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error("Không tìm thấy thư mục ảnh hoặc quá giới hạn API.");
            
            const data = await response.json();
            
            // Lọc ra các file ảnh
            fileList = data.filter(file => file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i));
            
            if (fileList.length === 0) {
                alert("Thư mục 'images' trên GitHub đang trống!");
                document.getElementById('loadingOverlay').style.display = 'none';
                return;
            }

            // Khởi tạo mảng góc xoay
            angles = new Array(fileList.length).fill(0);
            
            // Sắp xếp tên file
            fileList.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));

            // Bắt đầu
            document.getElementById('loadingOverlay').style.display = 'none';
            hasUnsavedChanges = true;
            
            document.getElementById('btnNext').disabled = false;
            document.getElementById('btnPrev').disabled = false;
            document.getElementById('btnDownload').disabled = false;
            
            loadImage();

        } catch (error) {
            alert("Lỗi: " + error.message + "\n\n(Lưu ý: GitHub API giới hạn 60 lần tải/giờ. Nếu lỗi, hãy đợi 1 tiếng sau quay lại).");
            document.getElementById('progressText').innerText = "Lỗi tải dữ liệu!";
        }
    }

    function loadImage() {
        if (fileList.length === 0) return;
        const file = fileList[currentIndex];
        const angle = angles[currentIndex];

        document.getElementById('fileNameDisplay').innerText = file.name;
        document.getElementById('counter').innerText = `${currentIndex + 1} / ${fileList.length}`;
        
        const badge = document.getElementById('editedBadge');
        badge.style.display = (angle % 360 !== 0) ? "inline" : "none";

        const img = document.getElementById('currentImage');
        // Dùng download_url từ GitHub API
        img.src = file.download_url;
        img.style.transform = `rotate(${angle}deg)`;
    }

    function rotate(deg) {
        if (fileList.length === 0) return;
        angles[currentIndex] += deg;
        document.getElementById('currentImage').style.transform = `rotate(${angles[currentIndex]}deg)`;
        
        const badge = document.getElementById('editedBadge');
        badge.style.display = (angles[currentIndex] % 360 !== 0) ? "inline" : "none";
    }

    function navigate(direction) {
        if (fileList.length === 0) return;
        const nextIndex = currentIndex + direction;
        if (nextIndex >= 0 && nextIndex < fileList.length) {
            currentIndex = nextIndex;
            loadImage();
        } else if (nextIndex >= fileList.length) {
            if(confirm("Đã hết danh sách! Tải Zip về ngay?")) processAndDownload();
        }
    }

    async function processAndDownload() {
        if (!confirm("Bắt đầu tải và nén ảnh?")) return;

        const zip = new JSZip();
        const overlay = document.getElementById('loadingOverlay');
        const progressText = document.getElementById('progressText');
        const loadingTitle = document.getElementById('loadingTitle');
        
        loadingTitle.innerText = "Đang xử lý & Nén Zip...";
        overlay.style.display = 'flex';

        for (let i = 0; i < fileList.length; i++) {
            const fileData = fileList[i];
            progressText.innerText = `Đang xử lý: ${i + 1}/${fileList.length} (${fileData.name})`;
            
            const angle = angles[i] % 360;
            const imgUrl = fileData.download_url;

            try {
                // Tải ảnh về từ GitHub dưới dạng Blob
                const response = await fetch(imgUrl);
                const blob = await response.blob();

                if (angle === 0) {
                    zip.file(fileData.name, blob);
                } else {
                    const rotatedBlob = await rotateImageBlob(blob, angle);
                    zip.file(fileData.name, rotatedBlob);
                }
            } catch (err) {
                console.error("Lỗi tải ảnh:", fileData.name, err);
            }
        }

        progressText.innerText = "Đang tạo file Zip...";
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "ket_qua_xoay.zip");
            overlay.style.display = 'none';
            hasUnsavedChanges = false;
            alert("Xong!");
        });
    }

    function rotateImageBlob(blob, angle) {
        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "anonymous"; // Quan trọng để vẽ ảnh từ domain khác
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                const rads = angle * Math.PI / 180;
                
                const newWidth = Math.abs(img.width * Math.cos(rads)) + Math.abs(img.height * Math.sin(rads));
                const newHeight = Math.abs(img.width * Math.sin(rads)) + Math.abs(img.height * Math.cos(rads));

                canvas.width = newWidth;
                canvas.height = newHeight;
                ctx.translate(newWidth / 2, newHeight / 2);
                ctx.rotate(rads);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);

                canvas.toBlob((b) => resolve(b), blob.type, 0.9);
            };
            img.src = URL.createObjectURL(blob);
        });
    }

    document.addEventListener('keydown', (e) => {
        if (fileList.length === 0) return;
        if (e.key === "ArrowLeft") rotate(-90);
        if (e.key === "ArrowRight") rotate(90);
        if (e.key === "a" || e.key === "A") navigate(-1);
        if (e.key === "d" || e.key === "D") navigate(1);
        if (e.key === "Enter") navigate(1);
    });
</script>

</body>
</html>
