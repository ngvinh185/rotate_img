<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Xoay Ảnh (Github Version)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; background: #222; color: #fff; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: #333; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .upload-area { border: 2px dashed #555; padding: 30px; margin-bottom: 20px; border-radius: 8px; cursor: pointer; }
        .upload-area:hover { border-color: #17a2b8; background: #3a3a3a; }
        .image-wrapper { position: relative; height: 500px; background-color: #111; display: flex; align-items: center; justify-content: center; border-radius: 8px; overflow: hidden; margin: 20px 0; border: 2px solid #555; }
        #currentImage { max-height: 100%; max-width: 100%; transition: transform 0.3s; }
        .controls { display: flex; justify-content: center; gap: 12px; margin-top: 15px; }
        button { padding: 12px 24px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; font-size: 15px; }
        button:disabled { background: #555 !important; cursor: not-allowed; opacity: 0.6; }
        .btn-rotate { background: #17a2b8; }
        .btn-nav { background: #28a745; width: 160px; justify-content: center; } 
        .btn-dl { background: #ffc107; color: #333; width: 100%; justify-content: center; margin-top: 20px; font-size: 18px; padding: 15px; }
        .status-bar { display: flex; justify-content: space-between; color: #aaa; margin-bottom: 10px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .edited-badge { color: #28a745; font-weight: bold; margin-left: 10px; display: none;}
    </style>
</head>
<body>

<div id="loadingOverlay">
    <h2 style="color: #17a2b8;">Đang xử lý ảnh & Nén Zip...</h2>
    <p>Vui lòng không tắt trình duyệt.</p>
    <h3 id="progressText">0%</h3>
</div>

<div class="container">
    <h2><i class="fas fa-globe"></i> Tool Xoay Ảnh Online</h2>
    
    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-folder-open fa-3x" style="color: #aaa; margin-bottom: 10px;"></i>
        <p>Bấm chọn tất cả ảnh cần làm</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display: none;" onchange="handleFiles(this.files)">
    </div>

    <div class="status-bar">
        <span>[←/→]: Xoay | [A/D]: Next</span>
        <span id="counter">0 / 0</span>
    </div>

    <div style="font-size: 18px; margin-bottom: 5px;">
        <span style="color: #ffc107; font-weight: bold;" id="fileNameDisplay">Chưa có ảnh</span>
        <span id="editedBadge" class="edited-badge"><i class="fas fa-check"></i> ĐÃ SỬA</span>
    </div>
    
    <div class="image-wrapper">
        <img id="currentImage" src="" alt="">
    </div>

    <div class="controls">
        <button class="btn-nav" id="btnPrev" onclick="navigate(-1)" disabled><i class="fas fa-arrow-left"></i> (A) Quay lại</button>
        <button class="btn-rotate" onclick="rotate(-90)"><i class="fas fa-undo"></i> Trái</button>
        <button class="btn-rotate" onclick="rotate(90)">Phải <i class="fas fa-redo"></i></button>
        <button class="btn-nav" id="btnNext" onclick="navigate(1)" disabled>(D) Tiếp theo <i class="fas fa-arrow-right"></i></button>
    </div>

    <button onclick="processAndDownload()" class="btn-dl" id="btnDownload" disabled>
        <i class="fas fa-file-download"></i> Xong tất cả - Tải Zip về
    </button>
</div>

<script>
    let fileList = []; 
    let angles = [];   
    let currentIndex = 0;
    // Cờ đánh dấu để cảnh báo khi tắt trang
    let hasUnsavedChanges = false;

    // --- CHỐNG TẮT NHẦM ---
    window.onbeforeunload = function() {
        if (hasUnsavedChanges) {
            return "Bạn chưa tải file Zip. Nếu thoát bây giờ, mọi công sức sẽ mất hết!";
        }
    };

    function handleFiles(files) {
        if (files.length === 0) return;
        fileList = Array.from(files).sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
        angles = new Array(fileList.length).fill(0);
        currentIndex = 0;
        
        hasUnsavedChanges = true; // Bắt đầu tính là có dữ liệu
        
        updateUI();
        loadImage();
        
        document.getElementById('btnNext').disabled = false;
        document.getElementById('btnPrev').disabled = false;
        document.getElementById('btnDownload').disabled = false;
    }

    function loadImage() {
        if (fileList.length === 0) return;
        const file = fileList[currentIndex];
        const angle = angles[currentIndex];

        document.getElementById('fileNameDisplay').innerText = file.name;
        document.getElementById('counter').innerText = `${currentIndex + 1} / ${fileList.length}`;
        
        // Hiện chữ "ĐÃ SỬA" nếu góc khác 0
        const badge = document.getElementById('editedBadge');
        if (angle % 360 !== 0) badge.style.display = "inline";
        else badge.style.display = "none";

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById('currentImage');
            img.src = e.target.result;
            img.style.transform = `rotate(${angle}deg)`;
        }
        reader.readAsDataURL(file);
    }

    function rotate(deg) {
        if (fileList.length === 0) return;
        angles[currentIndex] += deg;
        document.getElementById('currentImage').style.transform = `rotate(${angles[currentIndex]}deg)`;
        
        // Cập nhật trạng thái badge
        const badge = document.getElementById('editedBadge');
        if (angles[currentIndex] % 360 !== 0) badge.style.display = "inline";
        else badge.style.display = "none";
    }

    function navigate(direction) {
        if (fileList.length === 0) return;
        const nextIndex = currentIndex + direction;
        if (nextIndex >= 0 && nextIndex < fileList.length) {
            currentIndex = nextIndex;
            loadImage();
        } else if (nextIndex >= fileList.length) {
            // Khi đến ảnh cuối cùng, nhắc nhở tải về
            const doDownload = confirm("Đã hết danh sách ảnh! Bạn có muốn tải Zip về ngay không?");
            if (doDownload) processAndDownload();
        }
    }

    async function processAndDownload() {
        if (fileList.length === 0) return;
        
        // Hỏi xác nhận lần cuối
        if (!confirm("Bắt đầu xử lý và tải về? (Máy sẽ hơi lag xíu nhé)")) return;

        const zip = new JSZip();
        const overlay = document.getElementById('loadingOverlay');
        const progressText = document.getElementById('progressText');
        
        overlay.style.display = 'flex';

        for (let i = 0; i < fileList.length; i++) {
            progressText.innerText = `Đang xử lý: ${i + 1}/${fileList.length} (${fileList[i].name})`;
            
            const file = fileList[i];
            const angle = angles[i] % 360;

            if (angle === 0) {
                zip.file(file.name, file);
            } else {
                const blob = await rotateImageFile(file, angle);
                zip.file(file.name, blob);
            }
        }

        progressText.innerText = "Đang nén file Zip...";
        
        zip.generateAsync({type:"blob"}).then(function(content) {
            saveAs(content, "anh_da_xoay_ok.zip");
            overlay.style.display = 'none';
            hasUnsavedChanges = false; // Tắt cảnh báo vì đã tải xong
            alert("Đã tải xong! Kiểm tra thư mục Downloads nhé.");
        });
    }

    function rotateImageFile(file, angle) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement("canvas");
                const ctx = canvas.getContext("2d");
                const rads = angle * Math.PI / 180;
                const newWidth = Math.abs(img.width * Math.cos(rads)) + Math.abs(img.height * Math.sin(rads));
                const newHeight = Math.abs(img.width * Math.sin(rads)) + Math.abs(img.height * Math.cos(rads));

                canvas.width = newWidth;
                canvas.height = newHeight;
                ctx.translate(newWidth / 2, newHeight / 2);
                ctx.rotate(rads);
                ctx.drawImage(img, -img.width / 2, -img.height / 2);

                canvas.toBlob((blob) => {
                    resolve(blob);
                }, file.type, 0.9); // Chất lượng ảnh 0.9
            };
            img.src = URL.createObjectURL(file);
        });
    }

    document.addEventListener('keydown', (e) => {
        if (fileList.length === 0) return;
        if (e.key === "ArrowLeft") rotate(-90);
        if (e.key === "ArrowRight") rotate(90);
        if (e.key === "a" || e.key === "A") navigate(-1);
        if (e.key === "d" || e.key === "D") navigate(1);
        if (e.key === "Enter") navigate(1);
    });
    
    function updateUI() {} // Placeholder
</script>

</body>
</html>
