<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Speed Labeling Tool</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #121212;
        color: #ececec;
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* SIDEBAR */
      .sidebar {
        width: 280px;
        background: #1e1e1e;
        border-right: 1px solid #333;
        display: flex;
        flex-direction: column;
        padding: 15px;
      }
      .label-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }
      .label-btn {
        background: #333;
        color: #aaa;
        border: 2px solid transparent;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        font-size: 0.85em;
        transition: 0.2s;
      }
      .label-btn:hover {
        background: #444;
      }
      .label-btn.active {
        background: #0078d4;
        color: white;
        border-color: #55aaff;
        font-weight: bold;
        box-shadow: 0 0 8px rgba(0, 120, 212, 0.6);
      }

      /* MAIN AREA */
      .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #000;
        position: relative;
      }

      /* STATUS BAR */
      .status-bar {
        height: 40px;
        background: #111;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
      }
      .counter-badge {
        background: #333;
        color: #ffc107;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
      }
      .filename-display {
        color: #888;
        font-size: 0.9em;
      }

      /* WORKSPACE */
      .workspace {
        flex: 1;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: #0d0d0d;
      }
      #image-wrapper {
        position: relative;
        max-width: 100%;
        max-height: 100%;
      }
      #image {
        max-width: 100%;
        display: block;
      }

      /* OVERLAY LỚP PHỦ */
      #overlay-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      /* KHUNG ĐÃ LƯU */
      .saved-box {
        position: absolute;
        border: 2px solid #28a745;
        background: rgba(40, 167, 69, 0.1);
        pointer-events: auto;
      }
      .saved-box:hover {
        background: rgba(220, 53, 69, 0.3);
        border-color: #dc3545;
        cursor: pointer;
      }
      .saved-box span {
        position: absolute;
        top: -22px;
        left: -2px;
        background: #28a745;
        color: white;
        padding: 2px 6px;
        font-size: 12px;
        border-radius: 3px;
        white-space: nowrap;
        font-weight: bold;
      }
      .saved-box:hover span {
        background: #dc3545;
        content: "Xóa";
      }

      /* NAV BAR */
      .bottom-nav {
        height: 60px;
        background: #1e1e1e;
        border-top: 1px solid #333;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
      }
      .btn {
        padding: 10px 20px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-weight: bold;
        color: white;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .btn-back {
        background: #444;
      }
      .btn-next {
        background: #28a745;
        font-size: 16px;
        padding: 10px 40px;
      }

      .hint {
        color: #666;
        font-size: 0.8em;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <h4 style="margin: 0 0 15px 0; color: #ccc">1. CHỌN NHÃN</h4>
      <div class="label-grid">
        {% for label in labels %}
        <button
          class="label-btn"
          id="btn-{{ label }}"
          onclick="selectLabel('{{ label }}')"
        >
          {{ loop.index }}. {{ label }}
        </button>
        {% endfor %}
      </div>

      <div
        style="margin-top: auto; border-top: 1px solid #333; padding-top: 10px"
      >
        <p class="hint">Danh sách chờ:</p>
        <ul
          id="stagedList"
          style="
            padding-left: 20px;
            color: #aaa;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
          "
        ></ul>
      </div>
    </div>

    <div class="main">
      <div class="status-bar">
        <span class="filename-display" id="fileNameDisplay">Loading...</span>
        <div class="counter-badge" id="counterBadge">0 / 0</div>
      </div>

      <div class="workspace">
        <div id="image-wrapper">
          <img id="image" src="" />
          <div id="overlay-layer"></div>
        </div>
      </div>

      <div class="bottom-nav">
        <button class="btn btn-back" onclick="navigate(-1)">
          <i class="fas fa-arrow-left"></i> Quay lại
        </button>

        <div class="hint">
          Vẽ khung -> Tự động thêm<br />
          Click khung xanh để xóa
        </div>

        <button class="btn btn-next" onclick="saveAndNext()">
          LƯU TẤT CẢ (Enter) <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
      const images = {{ images | tojson }};
      const labels = {{ labels | tojson }};
      let currentIndex = {{ last_index }};
      let activeLabel = labels[0];
      let stagedItems = [];
      let cropper = null;

      function init() {
          if (images.length === 0) {
              document.getElementById('fileNameDisplay').innerText = "Thư mục trống!";
              return;
          }

          document.getElementById('fileNameDisplay').innerText = images[currentIndex];
          document.getElementById('counterBadge').innerText = `Ảnh ${currentIndex + 1} / ${images.length}`;
          selectLabel(activeLabel);

          const img = document.getElementById('image');
          const overlay = document.getElementById('overlay-layer');

          if (cropper) cropper.destroy();
          overlay.innerHTML = '';
          stagedItems = [];
          updateListUI();

          img.src = `/image/${images[currentIndex]}?t=${Date.now()}`;

          img.onload = () => {
              cropper = new Cropper(img, {
                  viewMode: 1,
                  dragMode: 'crop',
                  autoCrop: false,
                  toggleDragModeOnDblclick: false,

                  // SỰ KIỆN QUAN TRỌNG: THẢ CHUỘT LÀ LƯU NGAY
                  cropend() {
                      setTimeout(() => {
                          const data = cropper.getData(true);
                          const cropBoxData = cropper.getCropBoxData();

                          // Chỉ lưu nếu khung lớn hơn 10px để tránh click nhầm
                          if (data.width > 10 && data.height > 10) {
                              addToStaging(data, cropBoxData);
                              cropper.clear(); // Xóa khung vẽ để vẽ cái mới
                          }
                      }, 10);
                  }
              });
          };
      }

      function selectLabel(label) {
          activeLabel = label;
          document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active'));
          document.getElementById(`btn-${label}`).classList.add('active');
      }

      function addToStaging(data, cropBoxData) {
          const newItem = { label: activeLabel, x: data.x, y: data.y, width: data.width, height: data.height };
          stagedItems.push(newItem);

          // Vẽ Visual Box màu xanh
          const div = document.createElement('div');
          div.className = 'saved-box';
          div.innerHTML = `<span>${activeLabel}</span>`;
          div.style.left = cropBoxData.left + 'px';
          div.style.top = cropBoxData.top + 'px';
          div.style.width = cropBoxData.width + 'px';
          div.style.height = cropBoxData.height + 'px';

          // Click vào box để xóa
          div.onclick = function() {
              const index = stagedItems.indexOf(newItem);
              if (index > -1) {
                  stagedItems.splice(index, 1);
                  div.remove();
                  updateListUI();
              }
          };
          document.getElementById('overlay-layer').appendChild(div);
          updateListUI();
      }

      function navigate(step) {
          const newIndex = currentIndex + step;
          if (newIndex >= 0 && newIndex < images.length) {
              currentIndex = newIndex;
              fetch('/update_progress', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ index: currentIndex })
              });
              init();
          } else {
              alert("Hết ảnh rồi!");
          }
      }

      function saveAndNext() {
          let nextIdx = currentIndex + 1;
          if (nextIdx >= images.length) nextIdx = 0;

          if (stagedItems.length === 0) {
              // Nếu không vẽ gì thì coi như bỏ qua ảnh này
              navigate(1);
              return;
          }

          fetch('/save_all_and_next', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                  filename: images[currentIndex],
                  items: stagedItems,
                  next_index: nextIdx
              })
          })
          .then(res => res.json())
          .then(data => {
              if (data.status === 'success') {
                  currentIndex = nextIdx;
                  init();
              }
          });
      }

      function updateListUI() {
          document.getElementById('stagedList').innerHTML = stagedItems.map(item => `<li>${item.label}</li>`).join('');
      }

      document.addEventListener('keydown', (e) => {
          if (e.key >= '1' && e.key <= '8') selectLabel(labels[parseInt(e.key)-1]);
          if (e.key === 'Enter') saveAndNext();
          if (e.key === 'ArrowLeft') navigate(-1);
      });

      init();
    </script>
  </body>
</html>
